<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お知らせ掲示板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .post {
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem 0;
        }
        .post:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800">お知らせ</h1>
            <p class="text-gray-500 mt-2">最新の情報をお届けします。</p>
        </header>

        <!-- 投稿フォーム (管理者のみ表示) -->
        <div id="post-form" class="bg-white p-6 rounded-lg shadow-md mb-10" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">新しいお知らせを投稿</h2>
            <div class="space-y-4">
                <input type="text" id="post-title" placeholder="タイトル" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="post-content" placeholder="内容" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button id="submit-post" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">投稿する</button>
            </div>
        </div>

        <!-- 投稿表示エリア -->
        <div id="posts-container" class="bg-white rounded-lg shadow-md p-6">
            <p id="loading-message" class="text-center text-gray-500">読み込み中...</p>
        </div>

    </div>

    <script type="module">
        // Firebase SDKをインポートします
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebaseの初期設定 ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DUMMY_KEY", authDomain: "DUMMY_DOMAIN", projectId: "DUMMY_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ★★★ 管理者設定 ★★★ ---
        // 下記の "OWNER_USER_ID_HERE" を、ご主人様のFirebase User ID (UID) に書き換えてください。
        // ※ UIDの確認方法は後述いたします。
        const ownerUid = "OWNER_USER_ID_HERE";

        // --- Firestoreコレクションへの参照 ---
        const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);

        // --- DOM要素の取得 ---
        const postForm = document.getElementById('post-form');
        const titleInput = document.getElementById('post-title');
        const contentInput = document.getElementById('post-content');
        const submitButton = document.getElementById('submit-post');
        const postsContainer = document.getElementById('posts-container');
        const loadingMessage = document.getElementById('loading-message');

        // --- 投稿をFirestoreに保存する関数 ---
        const addPost = async () => {
            if (auth.currentUser?.uid !== ownerUid) {
                alert("投稿権限がありません。");
                return;
            }

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (title === "" || content === "") {
                alert("タイトルと内容を入力してください。");
                return;
            }

            try {
                await addDoc(postsCollectionRef, {
                    title: title,
                    content: content,
                    createdAt: serverTimestamp(),
                    owner: auth.currentUser.uid // 投稿者のIDを記録します
                });
                titleInput.value = "";
                contentInput.value = "";
            } catch (error) {
                console.error("投稿の追加中にエラーが発生しました: ", error);
                alert("投稿に失敗しました。");
            }
        };
        
        // --- Firestoreから投稿をリアルタイムで取得・表示する関数 ---
        const getPosts = () => {
            const q = query(postsCollectionRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    postsContainer.innerHTML = '<p class="text-center text-gray-500">まだ投稿がありません。</p>';
                    return;
                }
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }

                postsContainer.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postElement = document.createElement('div');
                    postElement.classList.add('post');

                    const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString('ja-JP') : '日時不明';
                    
                    postElement.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800">${escapeHTML(post.title)}</h3>
                        <p class="text-sm text-gray-500 mb-2">${escapeHTML(postDate)}</p>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(post.content)}</p>
                    `;
                    postsContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("投稿の取得中にエラーが発生しました:", error);
                postsContainer.innerHTML = '<p class="text-center text-red-500">投稿の読み込みに失敗しました。</p>';
            });
        };

        // --- HTMLエスケープ関数 ---
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (match) => {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        };

        // --- イベントリスナーの設定 ---
        submitButton.addEventListener('click', addPost);

        // --- 認証状態の監視とUI制御 ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ユーザーがログインしている場合
                console.log('ログイン中のユーザーUID:', user.uid); // UID確認用
                if (user.uid === ownerUid) {
                    // もし管理者であれば、投稿フォームを表示します
                    postForm.style.display = 'block';
                } else {
                    // 管理者でなければ、投稿フォームを非表示にします
                    postForm.style.display = 'none';
                }
                // 投稿を読み込みます
                getPosts();
            } else {
                // ユーザーがログアウトしている場合
                postForm.style.display = 'none'; // 投稿フォームを非表示
                postsContainer.innerHTML = '<p class="text-center text-gray-500">お知らせの読み込みに失敗しました。</p>';
            }
        });

        // --- アプリケーションの開始 ---
        const startApp = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };
        
        startApp();

    </script>
</body>
</html>

